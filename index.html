<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Form Coach</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        video {
            display: none;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #stats {
            position: absolute;
            top: 60px;
            left: 30px;
            z-index: 10;
            text-shadow: 2px 2px 4px #000;
        }
        
        #reps {
            font-size: 60px;
            font-weight: bold;
        }
        
        #angle {
            font-size: 30px;
            color: #ccc;
        }
        
        #feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 70px;
            font-weight: bold;
            text-shadow: 3px 3px 6px #000;
            z-index: 10;
        }
        
        .good { color: #0f0; }
        .warn { color: #fa0; }
        .bad { color: #f00; }
        
        button {
            position: absolute;
            padding: 15px 30px;
            font-size: 18px;
            background: #f00;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 10;
        }
        
        button:hover {
            background: #f33;
        }
        
        #reset { bottom: 30px; right: 30px; }
        #quit { bottom: 30px; right: 150px; }
        #toggleVideo { bottom: 30px; left: 30px; }
        
        #instructions {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-size: 16px;
            z-index: 10;
        }
        
        /* Exercise selection screen */
        #exerciseSelection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        
        #exerciseSelection h1 {
            font-size: 48px;
            margin-bottom: 50px;
        }
        
        .exercise-btn {
            position: static;
            margin: 20px;
            padding: 30px 60px;
            font-size: 32px;
            background: #4CAF50;
            width: 400px;
        }
        
        .exercise-btn:hover {
            background: #66BB6A;
        }
        
        @media (max-width: 768px) {
            button {
                bottom: 20px;
                padding: 12px 24px;
                font-size: 16px;
            }
            
            #reset { right: 20px; }
            #quit { right: 130px; }
            
            #reps { font-size: 48px; }
            #angle { font-size: 24px; }
            #feedback { font-size: 50px; }
            
            .exercise-btn {
                width: 80%;
                font-size: 24px;
                padding: 20px 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Exercise Selection Screen -->
    <div id="exerciseSelection">
        <h1>Choose Exercise</h1>
        <button class="exercise-btn" onclick="startExercise('squat')">SQUAT</button>
        <button class="exercise-btn" onclick="startExercise('overhead')">OVERHEAD PRESS</button>
    </div>
    
    <!-- Main App -->
    <div id="container" style="display: none;">
        <div id="instructions"></div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="stats">
            <div id="reps">0</div>
            <div id="angle">--°</div>
        </div>
        <div id="feedback"></div>
        <button id="reset">RESET</button>
        <button id="quit">QUIT</button>
        <button id="toggleVideo">VIDEO ON</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const repsEl = document.getElementById('reps');
        const angleEl = document.getElementById('angle');
        const feedbackEl = document.getElementById('feedback');
        const instructionsEl = document.getElementById('instructions');

        let repCount = 0;
        let stage = null;
        let isReady = false;
        let readyTimer = null;
        let showVideo = true;
        let currentExercise = null;
        let squatStartBackAngle = null;
        let startKneeAngle = null;
        let startBackAngle = null;

        function playBeep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 1800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.08);
            } catch(e) {}
        }

        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            return angle > 180.0 ? 360 - angle : angle;
        }

        function detectView(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            if (!nose || !leftShoulder || !rightShoulder) return 'unclear';
            
            const shoulderWidth = Math.abs(leftShoulder.x - rightShoulder.x);
            if (shoulderWidth < 0.1) {
                return leftShoulder.visibility > rightShoulder.visibility ? 'side_left' : 'side_right';
            }
            
            const shoulderCenter = (leftShoulder.x + rightShoulder.x) / 2;
            const noseOffset = Math.abs(nose.x - shoulderCenter);
            return noseOffset < shoulderWidth * 0.3 ? 'front' : 'side_left';
        }

        function startExercise(exercise) {
            currentExercise = exercise;
            document.getElementById('exerciseSelection').style.display = 'none';
            document.getElementById('container').style.display = 'block';
            
            // Set instructions based on exercise
            if (exercise === 'squat') {
                instructionsEl.textContent = 'Stand SIDEWAYS • Full body visible • R = Reset • V = Video';
            } else if (exercise === 'overhead') {
                instructionsEl.textContent = 'Stand FACING camera • Dumbbells at shoulders • Full body visible';
            }
            
            // Start camera
            const camera = new Camera(video, {
                onFrame: async () => {
                    await pose.send({image: video});
                },
                width: 1280,
                height: 720
            });
            camera.start();
        }

        function onResults(results) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (showVideo) {
                ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;
                const view = detectView(landmarks);

                // Draw skeleton
                drawConnectors(ctx, landmarks, POSE_CONNECTIONS, {color: 'rgba(255,255,255,0.3)', lineWidth: 2});

                if (currentExercise === 'squat') {
                    processSquat(landmarks, view);
                } else if (currentExercise === 'overhead') {
                    processOverheadPress(landmarks, view);
                }
            }

            ctx.restore();
        }

        function processSquat(landmarks, view) {
            if (view === 'side_left' || view === 'side_right') {
                const idx = view === 'side_left' ? [23, 25, 27] : [24, 26, 28];
                const hip = landmarks[idx[0]];
                const knee = landmarks[idx[1]];
                const ankle = landmarks[idx[2]];

                if (hip?.visibility > 0.3 && knee?.visibility > 0.3 && ankle?.visibility > 0.3) {
                    ctx.fillStyle = '#0f0';
                    [hip, knee, ankle].forEach(p => {
                        ctx.beginPath();
                        ctx.arc(p.x * canvas.width, p.y * canvas.height, 8, 0, 2 * Math.PI);
                        ctx.fill();
                    });

                    const angle = calculateAngle(hip, knee, ankle);
                    angleEl.textContent = Math.round(angle) + '°';

                    if (!isReady && angle > 165) {
                        if (!readyTimer) {
                            readyTimer = setTimeout(() => { isReady = true; }, 2000);
                        }
                    } else if (angle < 165) {
                        clearTimeout(readyTimer);
                        readyTimer = null;
                    }

                    if (!isReady) {
                        feedbackEl.textContent = 'HOLD STILL (2s)';
                        feedbackEl.className = '';
                    } else {
                        if (angle > 160) stage = 'up';
                        if (angle < 100 && stage === 'up') {
                            stage = 'down';
                            repCount++;
                            repsEl.textContent = repCount;
                            playBeep();
                        }

                        // Simple depth feedback only
                        if (angle < 95) {
                            feedbackEl.textContent = 'GOOD DEPTH!';
                            feedbackEl.className = 'good';
                        } else if (angle < 100) {
                            feedbackEl.textContent = 'ALMOST!';
                            feedbackEl.className = 'warn';
                        } else if (angle < 120) {
                            feedbackEl.textContent = 'GO DEEPER';
                            feedbackEl.className = 'warn';
                        } else {
                            feedbackEl.textContent = '';
                        }
                    }
                } else {
                    feedbackEl.textContent = '';
                }
            } else if (view === 'front') {
                feedbackEl.textContent = 'TURN SIDEWAYS';
                feedbackEl.className = 'bad';
            }
        }

        function processOverheadPress(landmarks, view) {
            const leftShoulder = landmarks[11];
            const leftElbow = landmarks[13];
            const leftWrist = landmarks[15];
            
            const rightShoulder = landmarks[12];
            const rightElbow = landmarks[14];
            const rightWrist = landmarks[16];

            if (leftShoulder?.visibility > 0.3 && leftElbow?.visibility > 0.3 && leftWrist?.visibility > 0.3 &&
                rightShoulder?.visibility > 0.3 && rightElbow?.visibility > 0.3 && rightWrist?.visibility > 0.3) {
                
                ctx.fillStyle = '#0f0';
                [leftShoulder, leftElbow, leftWrist, rightShoulder, rightElbow, rightWrist].forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x * canvas.width, p.y * canvas.height, 8, 0, 2 * Math.PI);
                    ctx.fill();
                });

                const leftArmAngle = calculateAngle(leftShoulder, leftElbow, leftWrist);
                const rightArmAngle = calculateAngle(rightShoulder, rightElbow, rightWrist);
                const armAngle = (leftArmAngle + rightArmAngle) / 2;
                
                angleEl.textContent = Math.round(armAngle) + '°';

                if (!isReady) {
                    if (!readyTimer) {
                        readyTimer = setTimeout(() => { isReady = true; }, 2000);
                    }
                    feedbackEl.textContent = 'HOLD STILL (2s)';
                    feedbackEl.className = '';
                } else {
                    if (armAngle > 100 && armAngle < 130) stage = 'down';
                    if (armAngle > 150 && stage === 'down') {
                        stage = 'up';
                        repCount++;
                        repsEl.textContent = repCount;
                        playBeep();
                    }

                    // Simple lockout feedback + symmetry
                    const armDiff = Math.abs(leftArmAngle - rightArmAngle);
                    
                    if (armDiff > 25) {
                        feedbackEl.textContent = 'UNEVEN ARMS';
                        feedbackEl.className = 'warn';
                    } else if (armAngle > 150) {
                        feedbackEl.textContent = 'GOOD LOCKOUT!';
                        feedbackEl.className = 'good';
                    } else if (armAngle > 130) {
                        feedbackEl.textContent = 'ALMOST!';
                        feedbackEl.className = 'warn';
                    } else {
                        feedbackEl.textContent = '';
                    }
                }
            }
        }

        function reset() {
            repCount = 0;
            stage = null;
            isReady = false;
            startKneeAngle = null;
            startBackAngle = null;
            clearTimeout(readyTimer);
            readyTimer = null;
            repsEl.textContent = '0';
            angleEl.textContent = '--°';
            feedbackEl.textContent = '';
        }

        function quit() {
            video.srcObject?.getTracks().forEach(t => t.stop());
            document.getElementById('container').style.display = 'none';
            document.getElementById('exerciseSelection').style.display = 'flex';
            reset();
        }

        function toggleVideoFeed() {
            showVideo = !showVideo;
            const btn = document.getElementById('toggleVideo');
            btn.textContent = showVideo ? 'VIDEO ON' : 'SKELETON ONLY';
            btn.style.background = showVideo ? '#4CAF50' : '#ff3b30';
        }

        document.getElementById('reset').onclick = reset;
        document.getElementById('quit').onclick = quit;
        document.getElementById('toggleVideo').onclick = toggleVideoFeed;
        
        document.addEventListener('keydown', e => {
            if (e.key === 'r' || e.key === 'R') reset();
            if (e.key === 'q' || e.key === 'Q') quit();
            if (e.key === 'v' || e.key === 'V') toggleVideoFeed();
        });

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        // Set initial video toggle state
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('toggleVideo');
            btn.textContent = 'VIDEO ON';
            btn.style.background = '#4CAF50';
        });
    </script>
</body>
</html>