<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Form Coach</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-35FLR57M6Q"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-35FLR57M6Q');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        video {
            display: none;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #stats {
            position: absolute;
            top: 60px;
            left: 30px;
            z-index: 10;
            text-shadow: 2px 2px 4px #000;
        }
        
        #reps {
            font-size: 60px;
            font-weight: bold;
        }
        
        #repTarget {
            font-size: 24px;
            color: #4CAF50;
            margin-top: 5px;
        }

        #countdown {
            font-size: 32px;
            color: #0ff;
            font-weight: bold;
            margin-top: 10px;
        }  

        #angle {
            font-size: 30px;
            color: #ccc;
        }
        
        #feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 70px;
            font-weight: bold;
            text-shadow: 3px 3px 6px #000;
            z-index: 10;
        }
        
        .good { color: #0f0; }
        .warn { color: #fa0; }
        .bad { color: #f00; }
        .complete { color: #0ff; }
        
        button {
            position: absolute;
            padding: 15px 30px;
            font-size: 18px;
            background: #f00;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 10;
        }
        
        button:hover {
            background: #f33;
        }
        
        #reset { bottom: 30px; right: 30px; }
        #quit { bottom: 30px; right: 150px; }
        #toggleVideo { bottom: 30px; left: 30px; }
        #saveSet { bottom: 30px; left: 200px; background: #4CAF50; }
        #saveSet:hover { background: #66BB6A; }
        
        #instructions {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-size: 16px;
            z-index: 10;
        }
        
        /* Exercise selection screen */
        #exerciseSelection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        
        #exerciseSelection h1 {
            font-size: 48px;
            margin-bottom: 30px;
        }
        
        .exercise-btn {
            position: static;
            margin: 15px;
            padding: 30px 60px;
            font-size: 32px;
            background: #4CAF50;
            width: 400px;
        }
        
        .exercise-btn:hover {
            background: #66BB6A;
        }
        
        #repTargetInput {
            margin: 20px 0;
            padding: 15px;
            font-size: 20px;
            width: 300px;
            text-align: center;
            border-radius: 8px;
            border: 2px solid #4CAF50;
            background: #222;
            color: white;
        }
        
        #repTargetLabel {
            font-size: 18px;
            color: #ccc;
            margin-bottom: 10px;
        }
        
        #historyBtn {
            position: static;
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 20px;
            background: #666;
        }
        
        #historyBtn:hover {
            background: #888;
        }
        
        /* History screen */
        #historyScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            flex-direction: column;
            padding: 40px;
            overflow-y: auto;
            z-index: 20;
        }
        
        #historyScreen h1 {
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        #historyList {
            flex: 1;
            overflow-y: auto;
        }
        
        .history-item {
            background: #222;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .history-date {
            font-size: 14px;
            color: #888;
        }
        
        .history-exercise {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .history-reps {
            font-size: 18px;
            color: #4CAF50;
        }
        
        #closeHistory {
            position: static;
            margin-top: 20px;
            align-self: center;
            background: #666;
        }
        
        @media (max-width: 768px) {
            button {
                bottom: 20px;
                padding: 12px 24px;
                font-size: 16px;
            }
            
            #reset { right: 20px; }
            #quit { right: 130px; }
            #saveSet { left: 20px; bottom: 80px; }
            
            #reps { font-size: 48px; }
            #angle { font-size: 24px; }
            #feedback { font-size: 50px; }
            
            .exercise-btn {
                width: 80%;
                font-size: 24px;
                padding: 20px 40px;
            }
            
            #repTargetInput {
                width: 80%;
            }
        }
    </style>
</head>
<body>
    <!-- Exercise Selection Screen -->
    <div id="exerciseSelection">
        <h1>Choose Exercise</h1>
        
        <div id="repTargetLabel">Rep Target (optional - leave blank for open-ended)</div>
        <input type="number" id="repTargetInput" placeholder="e.g., 10" min="1" max="100">
        
        <button class="exercise-btn" onclick="startExercise('squat')">SQUAT</button>
        <button class="exercise-btn" onclick="startExercise('overhead')">OVERHEAD PRESS</button>
        
        <button id="historyBtn" onclick="showHistory()">VIEW HISTORY</button>
    </div>
    
    <!-- History Screen -->
    <div id="historyScreen">
        <h1>Workout History</h1>
        <div id="historyList"></div>
        <button id="closeHistory" onclick="closeHistory()">BACK</button>
    </div>
    
    <!-- Main App -->
    <div id="container" style="display: none;">
        <div id="instructions"></div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="stats">
            <div id="reps">0</div>
            <div id="repTarget"></div>
            <div id="countdown"></div>
            <div id="angle">--°</div>
        </div>
        <div id="feedback"></div>
        <button id="saveSet">SAVE SET</button>
        <button id="reset">RESET</button>
        <button id="quit">QUIT</button>
        <button id="toggleVideo">VIDEO ON</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const repsEl = document.getElementById('reps');
        const repTargetEl = document.getElementById('repTarget');
        const countdownEl = document.getElementById('countdown');
        const angleEl = document.getElementById('angle');
        const feedbackEl = document.getElementById('feedback');
        const instructionsEl = document.getElementById('instructions');

        let repCount = 0;
        let stage = null;
        let isReady = false;
        let readyTimer = null;
        let showVideo = true;
        let currentExercise = null;
        let repTarget = null;
        let targetComplete = false;

        function playBeep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 1800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.08);
            } catch(e) {}
        }

        function playCelebration() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                // Play 3 ascending beeps
                [1800, 2000, 2200].forEach((freq, i) => {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    const startTime = audioCtx.currentTime + (i * 0.15);
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(0.5, startTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.12);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.12);
                });
            } catch(e) {}
        }

        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            return angle > 180.0 ? 360 - angle : angle;
        }

        function detectView(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            if (!nose || !leftShoulder || !rightShoulder) return 'unclear';
            
            const shoulderWidth = Math.abs(leftShoulder.x - rightShoulder.x);
            if (shoulderWidth < 0.1) {
                return leftShoulder.visibility > rightShoulder.visibility ? 'side_left' : 'side_right';
            }
            
            const shoulderCenter = (leftShoulder.x + rightShoulder.x) / 2;
            const noseOffset = Math.abs(nose.x - shoulderCenter);
            return noseOffset < shoulderWidth * 0.3 ? 'front' : 'side_left';
        }

        function startExercise(exercise) {
            currentExercise = exercise;
            
            // Get rep target (optional)
            const targetInput = document.getElementById('repTargetInput');
            repTarget = targetInput.value ? parseInt(targetInput.value) : null;
            targetComplete = false;
            
            document.getElementById('exerciseSelection').style.display = 'none';
            document.getElementById('container').style.display = 'block';
            
            // Update rep target display
            if (repTarget) {
                repTargetEl.textContent = `Target: ${repTarget} reps`;
            } else {
                repTargetEl.textContent = '';
            }
            
            // Set instructions
            if (exercise === 'squat') {
                instructionsEl.textContent = 'Stand SIDEWAYS • Full body visible • R = Reset • V = Video';
            } else if (exercise === 'overhead') {
                instructionsEl.textContent = 'Face camera • Upper body visible • R = Reset • V = Video';
            }
            
            // Start camera
            const camera = new Camera(video, {
                onFrame: async () => {
                    await pose.send({image: video});
                },
                width: 1280,
                height: 720
            });
            camera.start();
        }

        function onResults(results) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (showVideo) {
                ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;
                const view = detectView(landmarks);

                drawConnectors(ctx, landmarks, POSE_CONNECTIONS, {color: 'rgba(255,255,255,0.3)', lineWidth: 2});

                if (currentExercise === 'squat') {
                    processSquat(landmarks, view);
                } else if (currentExercise === 'overhead') {
                    processOverheadPress(landmarks, view);
                }
            }

            ctx.restore();
        }

        function processSquat(landmarks, view) {
            if (view === 'side_left' || view === 'side_right') {
                const idx = view === 'side_left' ? [23, 25, 27] : [24, 26, 28];
                const hip = landmarks[idx[0]];
                const knee = landmarks[idx[1]];
                const ankle = landmarks[idx[2]];

                if (hip?.visibility > 0.3 && knee?.visibility > 0.3 && ankle?.visibility > 0.3) {
                    ctx.fillStyle = '#0f0';
                    [hip, knee, ankle].forEach(p => {
                        ctx.beginPath();
                        ctx.arc(p.x * canvas.width, p.y * canvas.height, 8, 0, 2 * Math.PI);
                        ctx.fill();
                    });

                    const angle = calculateAngle(hip, knee, ankle);
                    angleEl.textContent = Math.round(angle) + '°';

                    if (!isReady && angle > 165) {
                        if (!readyTimer) {
                            readyTimer = setTimeout(() => { isReady = true; }, 2000);
                        }
                    } else if (angle < 165) {
                        clearTimeout(readyTimer);
                        readyTimer = null;
                    }

                    if (!isReady) {
                        feedbackEl.textContent = 'HOLD STILL (2s)';
                        feedbackEl.className = '';
                    } else {
                        if (angle > 160) stage = 'up';
                        if (angle < 100 && stage === 'up') {
                            stage = 'down';
                            repCount++;
                            repsEl.textContent = repCount;
                            playBeep();
                            
                            // Check if target complete
                            if (repTarget && repCount >= repTarget && !targetComplete) {
                                targetComplete = true;
                                playCelebration();
                            }
                        }
                        // Show feedback or target progress
                        if (targetComplete) {
                            countdownEl.textContent = '✓ COMPLETE!';
                            feedbackEl.textContent = 'TARGET COMPLETE!';
                            feedbackEl.className = 'complete';
                        } else if (repTarget) {
                            const remaining = repTarget - repCount;
                            if (remaining > 0 && remaining <= 3) {
                                countdownEl.textContent = `${remaining} LEFT!`;
                            } else if (remaining > 0) {
                                countdownEl.textContent = `${remaining} to go`;
                            } else {
                                countdownEl.textContent = '';
                            }
                            
                            // Depth feedback (center) - always show during squat
                            if (angle < 95) {
                                feedbackEl.textContent = 'GOOD DEPTH!';
                                feedbackEl.className = 'good';
                            } else if (angle < 100) {
                                feedbackEl.textContent = 'ALMOST!';
                                feedbackEl.className = 'warn';
                            } else if (angle < 120) {
                                feedbackEl.textContent = 'GO DEEPER';
                                feedbackEl.className = 'warn';
                            } else {
                                feedbackEl.textContent = '';
                            }
                        } else {
                            countdownEl.textContent = '';
                            
                            // Normal depth feedback
                            if (angle < 95) {
                                feedbackEl.textContent = 'GOOD DEPTH!';
                                feedbackEl.className = 'good';
                            } else if (angle < 100) {
                                feedbackEl.textContent = 'ALMOST!';
                                feedbackEl.className = 'warn';
                            } else if (angle < 120) {
                                feedbackEl.textContent = 'GO DEEPER';
                                feedbackEl.className = 'warn';
                            } else {
                                feedbackEl.textContent = '';
                            }
                        }
                    }
                }
            } else if (view === 'front') {
                feedbackEl.textContent = 'TURN SIDEWAYS';
                feedbackEl.className = 'bad';
            }
        }

        function processOverheadPress(landmarks, view) {
            const leftShoulder = landmarks[11];
            const leftElbow = landmarks[13];
            const leftWrist = landmarks[15];
            
            const rightShoulder = landmarks[12];
            const rightElbow = landmarks[14];
            const rightWrist = landmarks[16];

            if (leftShoulder?.visibility > 0.3 && leftElbow?.visibility > 0.3 && leftWrist?.visibility > 0.3 &&
                rightShoulder?.visibility > 0.3 && rightElbow?.visibility > 0.3 && rightWrist?.visibility > 0.3) {
                
                ctx.fillStyle = '#0f0';
                [leftShoulder, leftElbow, leftWrist, rightShoulder, rightElbow, rightWrist].forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x * canvas.width, p.y * canvas.height, 8, 0, 2 * Math.PI);
                    ctx.fill();
                });

                const leftArmAngle = calculateAngle(leftShoulder, leftElbow, leftWrist);
                const rightArmAngle = calculateAngle(rightShoulder, rightElbow, rightWrist);
                const armAngle = (leftArmAngle + rightArmAngle) / 2;
                
                angleEl.textContent = Math.round(armAngle) + '°';

                if (!isReady) {
                    if (!readyTimer) {
                        readyTimer = setTimeout(() => { isReady = true; }, 2000);
                    }
                    feedbackEl.textContent = 'HOLD STILL (2s)';
                    feedbackEl.className = '';
                } else {
                    if (armAngle > 100 && armAngle < 130) stage = 'down';
                    if (armAngle > 150 && stage === 'down') {
                        stage = 'up';
                        repCount++;
                        repsEl.textContent = repCount;
                        playBeep();
                        
                        if (repTarget && repCount >= repTarget && !targetComplete) {
                            targetComplete = true;
                            playCelebration();
                        }
                    }

                    const armDiff = Math.abs(leftArmAngle - rightArmAngle);
                    
                    // Show countdown separately
                    if (targetComplete) {
                        countdownEl.textContent = '✓ COMPLETE!';
                        feedbackEl.textContent = 'TARGET COMPLETE!';
                        feedbackEl.className = 'complete';
                    } else if (repTarget) {
                        const remaining = repTarget - repCount;
                        if (remaining > 0 && remaining <= 3) {
                            countdownEl.textContent = `${remaining} LEFT!`;
                        } else if (remaining > 0) {
                            countdownEl.textContent = `${remaining} to go`;
                        } else {
                            countdownEl.textContent = '';
                        }
                        
                        // Form feedback (center)
                        if (armDiff > 25) {
                            feedbackEl.textContent = 'UNEVEN ARMS';
                            feedbackEl.className = 'warn';
                        } else if (armAngle > 150) {
                            feedbackEl.textContent = 'GOOD LOCKOUT!';
                            feedbackEl.className = 'good';
                        } else if (armAngle > 130) {
                            feedbackEl.textContent = 'ALMOST!';
                            feedbackEl.className = 'warn';
                        } else {
                            feedbackEl.textContent = '';
                        }
                    } else {
                        countdownEl.textContent = '';
                        
                        if (armDiff > 25) {
                            feedbackEl.textContent = 'UNEVEN ARMS';
                            feedbackEl.className = 'warn';
                        } else if (armAngle > 150) {
                            feedbackEl.textContent = 'GOOD LOCKOUT!';
                            feedbackEl.className = 'good';
                        } else if (armAngle > 130) {
                            feedbackEl.textContent = 'ALMOST!';
                            feedbackEl.className = 'warn';
                        } else {
                            feedbackEl.textContent = '';
                        }
                    }
                }
            }
        }

        // Session history functions
        function saveSet() {
            if (repCount === 0) {
                alert('No reps to save!');
                return;
            }
            
            const workout = {
                date: new Date().toISOString(),
                exercise: currentExercise === 'squat' ? 'Squat' : 'Overhead Press',
                reps: repCount,
                target: repTarget
            };
            
            // Get existing history
            let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            history.unshift(workout); // Add to beginning
            
            // Keep only last 50 workouts
            if (history.length > 50) history = history.slice(0, 50);
            
            localStorage.setItem('workoutHistory', JSON.stringify(history));
            
            alert(`Saved: ${workout.exercise} - ${repCount} reps`);
        }

        function showHistory() {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666; font-size: 20px;">No workouts yet. Start training!</p>';
            } else {
                historyList.innerHTML = history.map(workout => {
                    const date = new Date(workout.date);
                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const targetStr = workout.target ? ` (target: ${workout.target})` : '';
                    
                    return `
                        <div class="history-item">
                            <div class="history-date">${dateStr}</div>
                            <div class="history-exercise">${workout.exercise}</div>
                            <div class="history-reps">${workout.reps} reps${targetStr}</div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('exerciseSelection').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'flex';
        }

        function closeHistory() {
            document.getElementById('historyScreen').style.display = 'none';
            document.getElementById('exerciseSelection').style.display = 'flex';
        }

        function reset() {
            repCount = 0;
            stage = null;
            isReady = false;
            targetComplete = false;
            clearTimeout(readyTimer);
            readyTimer = null;
            repsEl.textContent = '0';
            angleEl.textContent = '--°';
            feedbackEl.textContent = '';
            countdownEl.textContent = '';  // ADD THIS
        }


        function quit() {
            video.srcObject?.getTracks().forEach(t => t.stop());
            document.getElementById('container').style.display = 'none';
            document.getElementById('exerciseSelection').style.display = 'flex';
            reset();
            
            // Reset target input
            document.getElementById('repTargetInput').value = '';
            repTarget = null;
        }

        function toggleVideoFeed() {
            showVideo = !showVideo;
            const btn = document.getElementById('toggleVideo');
            btn.textContent = showVideo ? 'VIDEO ON' : 'SKELETON ONLY';
            btn.style.background = showVideo ? '#4CAF50' : '#ff3b30';
        }

        document.getElementById('reset').onclick = reset;
        document.getElementById('quit').onclick = quit;
        document.getElementById('saveSet').onclick = saveSet;
        document.getElementById('toggleVideo').onclick = toggleVideoFeed;
        
        document.addEventListener('keydown', e => {
            if (e.key === 'r' || e.key === 'R') reset();
            if (e.key === 'q' || e.key === 'Q') quit();
            if (e.key === 'v' || e.key === 'V') toggleVideoFeed();
            if (e.key === 's' || e.key === 'S') saveSet();
        });

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('toggleVideo');
            btn.textContent = 'VIDEO ON';
            btn.style.background = '#4CAF50';
        });
    </script>
</body>
</html>